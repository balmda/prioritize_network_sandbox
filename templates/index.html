<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Network Prioritization Template using Flask for weighted prioritization analysis.">
  <meta name="author" content="David Wasserman">
  <link rel="icon" href="https://img.icons8.com/material/24/000000/streets.png">
  <title>Network Prioritization</title>

  <!-- ===== Libs (CDN) - avoids /static/node_modules 404s ===== -->

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  >
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- jQuery -->
  <script
    src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
    crossorigin="anonymous"></script>

  <!-- chroma-js -->
  <script src="https://unpkg.com/chroma-js@2.4.2/chroma.min.js"></script>

  <!-- leaflet-ajax -->
  <script src="https://unpkg.com/leaflet-ajax@2.1.0/dist/leaflet.ajax.min.js"></script>

  <!-- Bootstrap (same as original) -->
  <link rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
        crossorigin="anonymous">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
          integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
          crossorigin="anonymous"></script>

  <!-- App CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='application/main.css') }}">

  <!-- Make criteria list available to JS -->
  <script>
    // Prefer criteria_keys if present; fall back to CRITERIA; final fallback empty list.
    window.CRITERIA =
      {{ (criteria_keys if criteria_keys is defined else (CRITERIA if CRITERIA is defined else [])) | tojson }};
  </script>
</head>

<body>
  <nav class="navbar navbar-dark bg-dark">
    <a class="navbar-brand mb-0 h1" href="#">Network Prioritization</a>
    <a class="navbar-brand mb-0 p" href="#">{{ project_title if project_title is defined else "" }}</a>
  </nav>

  <nav class="sidebar-nav navbar-dark bg-dark">
    <!-- refreshGeojson() intercepts submit; prevents POST / (405) -->
    <form id="sliderForm" method="POST" onsubmit="refreshGeojson();return false;">

      {# ---------------------------------------------
         Preferred path: criteria_meta passed from app.py
         Each item should look like:
           { key: "strava", label: "Strava Usage", value: 5.0 }
         --------------------------------------------- #}
      {% if criteria_meta is defined and criteria_meta %}
        {% for c in criteria_meta %}
          <div class="variableContainer">
            <p>{{ c.label if c.label is defined else c.key }}</p>
            <output class="output"
                    name="{{ c.key }}-text"
                    id="{{ c.key }}OutputId">{{ c.value }}</output>
          </div>

          <div class="slidecontainer">
            <div class="sliderdiv">
              <input type="range"
                     min="{{ weight_min if weight_min is defined else 0 }}"
                     max="{{ weight_max if weight_max is defined else 10 }}"
                     step="{{ weight_step if weight_step is defined else 0.5 }}"
                     value="{{ c.value }}"
                     class="slider"
                     id="slider_{{ c.key }}"
                     name="{{ c.key }}"
                     oninput="{{ c.key }}OutputId.value = this.value">
            </div>
          </div>
        {% endfor %}

      {# ---------------------------------------------
         Fallback path: criteria_keys + weights
         This keeps sliders working even if you didn't build criteria_meta.
         --------------------------------------------- #}
      {% else %}
        {% set _keys = criteria_keys if criteria_keys is defined else (CRITERIA if CRITERIA is defined else []) %}
        {% for k in _keys %}
          {% set _val = (weights[k] if weights is defined and k in weights else (globals().get(k) if globals is defined else 5.0)) %}
          <div class="variableContainer">
            <p>{{ k }}</p>
            <output class="output"
                    name="{{ k }}-text"
                    id="{{ k }}OutputId">{{ _val }}</output>
          </div>

          <div class="slidecontainer">
            <div class="sliderdiv">
              <input type="range"
                     min="{{ weight_min if weight_min is defined else 0 }}"
                     max="{{ weight_max if weight_max is defined else 10 }}"
                     step="{{ weight_step if weight_step is defined else 0.5 }}"
                     value="{{ _val }}"
                     class="slider"
                     id="slider_{{ k }}"
                     name="{{ k }}"
                     oninput="{{ k }}OutputId.value = this.value">
            </div>
          </div>
        {% endfor %}
      {% endif %}

      <div>
        <input class="updateButton" type="submit" value="Reweight Analysis">
        <div class="sliderTotal">
          <h6>Sum of Weights</h6>
          <h6 class="sliderTotalSum"></h6>
        </div>
      </div>
    </form>
  </nav>

  <div id="map"></div>

  <script src="{{ url_for('static', filename='application/main.js') }}?v=dev"></script>
</body>
</html>
